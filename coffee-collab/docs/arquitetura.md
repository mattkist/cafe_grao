# Arquitetura do Sistema - CAF√â GR√ÉO

Este documento descreve a arquitetura do sistema, decis√µes de design e padr√µes utilizados no desenvolvimento.

---

## üèóÔ∏è Vis√£o Geral da Arquitetura

O **CAF√â GR√ÉO** √© uma **Single Page Application (SPA)** que roda completamente do lado do cliente, sem necessidade de servidor backend pr√≥prio.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            Cliente (Navegador)                  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ   React     ‚îÇ      ‚îÇ   Firebase   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   (Vite)    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   Services   ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ         ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ         ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ Components  ‚îÇ      ‚îÇ  Auth + DB  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   Hooks     ‚îÇ      ‚îÇ  (Cloud)    ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                     ‚îÇ
         ‚îÇ                     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            Deploy: GitHub Pages
```

### Caracter√≠sticas Arquiteturais

1. **Frontend-only**: Toda l√≥gica roda no navegador
2. **BaaS (Backend as a Service)**: Firebase fornece backend completo
3. **Est√°tico**: Build gera arquivos est√°ticos (HTML/CSS/JS)
4. **SPA**: Roteamento client-side com React Router (m√∫ltiplas p√°ginas)
5. **Visualiza√ß√µes**: Gr√°ficos interativos com Apache ECharts

---

## üìÅ Estrutura de Pastas

```
src/
‚îú‚îÄ‚îÄ components/          # Componentes React reutiliz√°veis
‚îÇ   ‚îú‚îÄ‚îÄ Layout.jsx       # Componente de layout com sidebar e footer
‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.jsx      # Menu lateral naveg√°vel
‚îÇ   ‚îî‚îÄ‚îÄ LoginButton.jsx  # Componente de autentica√ß√£o
‚îÇ
‚îú‚îÄ‚îÄ pages/              # P√°ginas/rotas da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ Home.jsx        # P√°gina inicial
‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.jsx   # Dashboard principal
‚îÇ   ‚îî‚îÄ‚îÄ Charts.jsx      # P√°gina de gr√°ficos
‚îÇ
‚îú‚îÄ‚îÄ hooks/              # Custom hooks React
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.js      # Hook de autentica√ß√£o
‚îÇ
‚îú‚îÄ‚îÄ services/           # L√≥gica de neg√≥cio e integra√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ userService.js           # Opera√ß√µes de perfil de usu√°rio
‚îÇ   ‚îî‚îÄ‚îÄ contributionService.js   # Opera√ß√µes de contribui√ß√µes
‚îÇ
‚îú‚îÄ‚îÄ lib/                # Configura√ß√µes e utilit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ firebase.js     # Configura√ß√£o do Firebase (usa vari√°veis de ambiente)
‚îÇ   ‚îî‚îÄ‚îÄ googleDrive.js # Configura√ß√£o do Google Drive (usa vari√°veis de ambiente)
‚îÇ
‚îú‚îÄ‚îÄ App.jsx             # Componente raiz (configura√ß√£o de rotas)
‚îî‚îÄ‚îÄ main.jsx            # Entry point (ponto de entrada)
```

### Organiza√ß√£o por Responsabilidade

- **`components/`**: Componentes de UI reutiliz√°veis
- **`pages/`**: P√°ginas completas da aplica√ß√£o (rotas)
- **`hooks/`**: L√≥gica compartilhada e reutiliz√°vel (custom hooks)
- **`services/`**: L√≥gica de neg√≥cio e comunica√ß√£o com APIs/externos
- **`lib/`**: Configura√ß√µes globais e inicializa√ß√µes

---

## üîê Arquitetura de Autentica√ß√£o

### Fluxo de Autentica√ß√£o

```
1. Usu√°rio clica "Entrar com Google"
   ‚Üì
2. Firebase Auth abre popup Google OAuth
   ‚Üì
3. Usu√°rio autentica com conta Google
   ‚Üì
4. Firebase retorna token e dados do usu√°rio
   ‚Üì
5. useAuth hook armazena estado do usu√°rio
   ‚Üì
6. userService cria/atualiza perfil no Firestore
   ‚Üì
7. App renderiza conte√∫do autenticado
```

### Gerenciamento de Estado de Autentica√ß√£o

- **`useAuth` hook**: Gerencia estado global de autentica√ß√£o
- **Firebase Auth**: Fonte da verdade (valida√ß√£o server-side)
- **onAuthStateChanged**: Listener que atualiza estado automaticamente

---

## üíæ Arquitetura de Dados

### Modelo de Dados no Firestore

#### Collection: `users`

Armazena perfis de usu√°rios (um documento por usu√°rio).

```javascript
{
  uid: string,              // ID √∫nico do usu√°rio (mesmo do Firebase Auth)
  email: string | null,     // Email do usu√°rio
  displayName: string | null, // Nome exibido
  photoURL: string | null,  // URL da foto de perfil
  createdAt: Timestamp,     // Data de cria√ß√£o
  updatedAt: Timestamp      // Data de atualiza√ß√£o
}
```

**Regras de Seguran√ßa**:
- Usu√°rio autenticado pode **ler** qualquer perfil
- Usu√°rio s√≥ pode **escrever** seu pr√≥prio perfil (`uid` deve coincidir)

#### Collection: `contributions`

Armazena todas as contribui√ß√µes (compartilhadas entre todos os usu√°rios).

```javascript
{
  id: string,               // ID do documento (gerado automaticamente)
  userId: string,           // ID do usu√°rio que contribuiu
  userName: string | null,  // Nome do usu√°rio (para exibi√ß√£o)
  amount: number,           // Valor da contribui√ß√£o
  description: string,     // Descri√ß√£o da compra
  date: Timestamp,          // Data da contribui√ß√£o
  createdAt: Timestamp      // Data de cria√ß√£o do registro
}
```

**Regras de Seguran√ßa**:
- Qualquer usu√°rio autenticado pode **ler** todas as contribui√ß√µes
- Qualquer usu√°rio autenticado pode **escrever** novas contribui√ß√µes

### Padr√£o: Dados Compartilhados

**Decis√£o de Design**: Todos os usu√°rios veem os mesmos dados de contribui√ß√µes.

**Por qu√™**:
- Sistema colaborativo onde transpar√™ncia √© importante
- Todos precisam saber quem contribuiu e quando
- Facilita visualiza√ß√£o coletiva em gr√°ficos

---

## üé£ Padr√£o de Custom Hooks

### `useAuth`

**Prop√≥sito**: Centralizar toda l√≥gica de autentica√ß√£o.

**Retorna**:
```javascript
{
  user: User | null,        // Objeto do usu√°rio atual
  loading: boolean,         // Estado de carregamento
  signInWithGoogle: () => Promise,  // Fun√ß√£o de login
  signOut: () => Promise           // Fun√ß√£o de logout
}
```

**Benef√≠cios**:
- Reutiliz√°vel em qualquer componente
- Estado sincronizado automaticamente
- L√≥gica isolada e test√°vel

---

## üîß Padr√£o de Services

### `userService.js`

**Responsabilidade**: Opera√ß√µes de CRUD de perfis de usu√°rios.

**Fun√ß√µes**:
- `getOrCreateUserProfile(user)`: Cria perfil se n√£o existir, retorna se j√° existir

### `contributionService.js`

**Responsabilidade**: Opera√ß√µes de CRUD de contribui√ß√µes.

**Fun√ß√µes**:
- `addContribution(userId, userName, amount, description)`: Adiciona nova contribui√ß√£o
- `getAllContributions()`: Retorna todas as contribui√ß√µes ordenadas

**Padr√£o**: Cada service √© respons√°vel por uma entidade espec√≠fica do dom√≠nio.

---

## ‚öôÔ∏è Configura√ß√£o do Build (Vite)

### Base Path Condicional

**Configura√ß√£o no Vite** (`vite.config.js`):

```javascript
base: mode === 'production' ? '/cafe_grao/' : '/'
```

**Configura√ß√£o no React Router** (`App.jsx`):

```javascript
<BrowserRouter basename={import.meta.env.MODE === 'production' ? '/cafe_grao' : undefined}>
```

**Decis√£o**: Em desenvolvimento local, base √© `/` (raiz). Em produ√ß√£o (GitHub Pages), base √© `/cafe_grao/`.

**Por qu√™**: 
- GitHub Pages serve o app em um subpath (`/cafe_grao/`), mas localmente roda na raiz
- O Vite precisa saber o base path para gerar os links corretos dos assets
- O React Router precisa saber o basename para manter as rotas corretas durante navega√ß√£o
- **IMPORTANTE**: Sem o `basename` no Router, a URL pode mudar para a raiz (`https://mattkist.github.io/`) ao navegar

---

## üîí Seguran√ßa

### Regras do Firestore

```javascript
// Usu√°rios: leitura livre, escrita apenas do pr√≥prio perfil
match /users/{userId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null && request.auth.uid == userId;
}

// Contribui√ß√µes: leitura/escrita livre para autenticados
match /contributions/{docId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null;
}
```

**Princ√≠pios**:
- Sempre verificar autentica√ß√£o (`request.auth != null`)
- Usu√°rios s√≥ podem modificar seus pr√≥prios perfis
- Contribui√ß√µes s√£o p√∫blicas entre usu√°rios autenticados

---

## üöÄ Deploy

### Configura√ß√£o de Vari√°veis de Ambiente

‚ö†Ô∏è **IMPORTANTE**: Antes do deploy, configure todas as vari√°veis de ambiente:

**Desenvolvimento Local:**
- Crie arquivo `.env` na pasta `coffee-collab/` com todas as vari√°veis necess√°rias
- Veja `.env.example` como template

**Produ√ß√£o (GitHub Pages):**
- Configure GitHub Secrets com todas as vari√°veis `VITE_*`
- Vari√°veis necess√°rias: Firebase (7 vari√°veis) + Google OAuth (2 vari√°veis)
- **CR√çTICO**: Configure dom√≠nios autorizados no Firebase (veja `FIREBASE_SETUP.md`)
  - Adicione `mattkist.github.io` em Authentication ‚Üí Settings ‚Üí Authorized domains
- Veja `FIREBASE_SETUP.md` e `GOOGLE_DRIVE_SETUP.md` para detalhes

### Fluxo de Deploy

```
1. Push para branch `main`
   ‚Üì
2. GitHub Actions triggera workflow
   ‚Üì
3. Build: `npm run build` (Vite compila para `dist/`)
   - GitHub Secrets s√£o injetadas como vari√°veis de ambiente
   - Vite embute vari√°veis no JavaScript final
   ‚Üì
4. Copia `index.html` para `404.html` (fallback SPA)
   ‚Üì
5. Deploy para GitHub Pages
   ‚Üì
6. App dispon√≠vel em: https://mattkist.github.io/cafe_grao/
```

### Fallback SPA

GitHub Pages n√£o suporta roteamento client-side nativamente. Solu√ß√£o: copiar `index.html` para `404.html`. Quando uma rota n√£o existe, GitHub Pages serve `404.html`, que √© nosso app React, permitindo roteamento client-side.

---

## üîÑ Fluxo de Dados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Component  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ chama hook/service
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Hook     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   Service   ‚îÇ
‚îÇ  (useAuth)  ‚îÇ      ‚îÇ (Firestore)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                     ‚îÇ
       ‚îÇ atualiza estado     ‚îÇ atualiza banco
       ‚Üì                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Estado    ‚îÇ      ‚îÇ   Firestore  ‚îÇ
‚îÇ   React     ‚îÇ      ‚îÇ   (Cloud)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üó∫Ô∏è Arquitetura de Rotas

### React Router

O sistema utiliza **React Router** para gerenciar m√∫ltiplas p√°ginas dentro da SPA.

**Estrutura de Rotas**:
```
/               ‚Üí Home (p√°gina inicial)
/dashboard      ‚Üí Dashboard (contribui√ß√µes e a√ß√µes)
/charts         ‚Üí Charts (gr√°ficos e visualiza√ß√µes)
```

**Rotas Protegidas**:
- Rotas que requerem autentica√ß√£o usam `ProtectedRoute` ou verifica√ß√£o de `useAuth`
- Usu√°rios n√£o autenticados s√£o redirecionados para login

**Benef√≠cios**:
- Separa√ß√£o clara de funcionalidades por p√°gina
- Navega√ß√£o intuitiva (URLs significativas)
- Hist√≥rico do navegador funcional
- Deep linking (acesso direto a p√°ginas espec√≠ficas)

---

## üìä Visualiza√ß√£o de Dados

### Apache ECharts

O sistema utiliza **Apache ECharts** para criar gr√°ficos interativos e profissionais.

**Tipos de Gr√°ficos Utilizados**:
- **Gr√°fico de linha**: Evolu√ß√£o temporal das contribui√ß√µes
- **Gr√°fico de barras**: Contribui√ß√µes por usu√°rio
- **Gr√°fico de pizza**: Distribui√ß√£o de contribui√ß√µes
- **Gr√°fico de √°rea**: Estoque ao longo do tempo

**Caracter√≠sticas**:
- Interatividade nativa (hover, zoom, etc.)
- Responsivo por padr√£o
- Personaliza√ß√£o visual completa
- Performance otimizada

**Integra√ß√£o**:
- ECharts √© inicializado no `useEffect` dos componentes de gr√°ficos
- Dados v√™m do Firestore via services
- Atualiza√ß√£o autom√°tica quando dados mudam

---

## üìä Decis√µes de Design

### 1. Por que SPA com React Router?

- **Performance**: Carrega uma vez, navega√ß√£o instant√¢nea
- **Organiza√ß√£o**: Separa√ß√£o clara de funcionalidades em p√°ginas distintas
- **UX**: URLs significativas e hist√≥rico do navegador
- **GitHub Pages**: Ideal para SPAs est√°ticas com fallback SPA

### 2. Por que Firebase?

- **Sem servidor**: N√£o precisa de backend pr√≥prio
- **Gratuito**: Plano free suficiente para este projeto
- **Autentica√ß√£o pronta**: Google Auth integrado
- **Tempo real**: Firestore atualiza automaticamente

### 3. Por que Custom Hooks?

- **Reutiliza√ß√£o**: L√≥gica compartilhada facilmente
- **Testabilidade**: Hooks isolados s√£o mais f√°ceis de testar
- **Organiza√ß√£o**: Separa l√≥gica de apresenta√ß√£o

---

## üîÆ Melhorias Futuras

### Arquitetura

- **Context API**: Para estado global mais complexo
- **Lazy Loading**: Code splitting por rota (carregar p√°ginas sob demanda)
- **Error Boundaries**: Captura de erros por rota
- **Otimiza√ß√µes**: Performance e bundle size

### Funcionalidades com ECharts

- **Gr√°ficos em tempo real**: Atualiza√ß√£o autom√°tica quando novos dados chegam
- **Exporta√ß√£o**: Salvar gr√°ficos como imagem
- **Filtros interativos**: Filtrar dados diretamente nos gr√°ficos
- **Compara√ß√µes**: Comparar per√≠odos diferentes

### Funcionalidades

- **Upload de imagens**: Para evid√™ncias de compra (Google Drive - pasta compartilhada)
- **Edi√ß√£o de contribui√ß√µes**: Modal completo para editar contribui√ß√µes existentes
- **Notifica√ß√µes**: Alertas de caf√© acabando
- **Relat√≥rios**: Gr√°ficos e estat√≠sticas avan√ßadas

---

**√öltima atualiza√ß√£o**: Dezembro 2024

